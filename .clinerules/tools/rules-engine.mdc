---
description: Rules Engine detailed documentation - load only when needed
globs: 
alwaysApply: false
version: 1.0.0
updated: 2025-11-09
changelog: |
  v1.0.0 (2025-11-09): Initial stable version - complete rules engine documentation
---

# Rules Engine - è¯¦ç»†æ–‡æ¡£

> âš ï¸ æœ¬æ–‡æ¡£æŒ‰éœ€åŠ è½½ã€‚å¿«é€Ÿå‚è€ƒè¯·æŸ¥çœ‹ @tools/_registry.mdc

## ğŸ“‹ æ¦‚è¿°

Rules Engine æ˜¯ä¸€ä¸ªåŸºäº Node.js çš„è‡ªåŠ¨åŒ–è§„åˆ™ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºä»£ç è§„èŒƒéªŒè¯ã€æ ¼å¼åŒ–å’Œè‡ªåŠ¨åŒ–åº”ç”¨ã€‚

**é¡¹ç›®ä½ç½®**: `/home/averyubuntu/projects/rules`

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Rule Manager                â”‚
â”‚   (è§„åˆ™ç®¡ç†ã€åŠ è½½ã€å­˜å‚¨)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Rule Validator               â”‚
â”‚   (è§„åˆ™é…ç½®éªŒè¯ã€å®Œæ•´æ€§æ£€æŸ¥)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Rule Engine                 â”‚
â”‚   (è§„åˆ™æ‰§è¡Œã€æ–‡ä»¶å¤„ç†ã€åº”ç”¨é€»è¾‘)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜

#### 1. RuleManager (è§„åˆ™ç®¡ç†å™¨)
**æ–‡ä»¶**: `src/rule-manager.js`

**èŒè´£**:
- åŠ è½½è§„åˆ™æ–‡ä»¶ï¼ˆä» `config/rules/` ç›®å½•ï¼‰
- è§„åˆ™çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
- è§„åˆ™çŠ¶æ€ç®¡ç†ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- äº‹ä»¶å‘å°„ï¼ˆè§„åˆ™åŠ è½½ã€æ·»åŠ ã€åˆ é™¤æ—¶ï¼‰

**ä¸»è¦æ–¹æ³•**:
```javascript
class RuleManager extends EventEmitter {
  loadRules()              // ä»ç›®å½•åŠ è½½æ‰€æœ‰è§„åˆ™
  addRule(rule)            // æ·»åŠ æ–°è§„åˆ™
  removeRule(ruleId)       // åˆ é™¤è§„åˆ™
  getRule(ruleId)          // è·å–å•ä¸ªè§„åˆ™
  listRules(filter)        // åˆ—å‡ºè§„åˆ™ï¼ˆå¯è¿‡æ»¤ï¼‰
  enableRule(ruleId)       // å¯ç”¨è§„åˆ™
  disableRule(ruleId)      // ç¦ç”¨è§„åˆ™
  getRuleCount()           // è·å–è§„åˆ™æ€»æ•°
}
```

#### 2. RuleValidator (è§„åˆ™éªŒè¯å™¨)
**æ–‡ä»¶**: `src/rule-validator.js`

**èŒè´£**:
- éªŒè¯è§„åˆ™é…ç½®çš„æ­£ç¡®æ€§
- æ£€æŸ¥å¿…å¡«å­—æ®µ
- éªŒè¯å­—æ®µæ ¼å¼å’Œç±»å‹
- å¿«é€ŸéªŒè¯ï¼ˆquickValidateï¼‰

**éªŒè¯è§„åˆ™**:
- IDæ ¼å¼éªŒè¯
- ä¼˜å…ˆçº§èŒƒå›´éªŒè¯ï¼ˆ1-10ï¼‰
- æ¡ä»¶å¯¹è±¡éªŒè¯
- åŠ¨ä½œå¯¹è±¡éªŒè¯

#### 3. RuleEngine (è§„åˆ™å¼•æ“)
**æ–‡ä»¶**: `src/rule-engine.js`

**èŒè´£**:
- æ‰§è¡Œè§„åˆ™åº”ç”¨é€»è¾‘
- æ–‡ä»¶ç±»å‹åŒ¹é…
- æ‰¹é‡æ–‡ä»¶å¤„ç†
- è§„åˆ™æ‰§è¡Œç»“æœåé¦ˆ

**å¤„ç†æµç¨‹**:
1. æ¥æ”¶æ–‡ä»¶è·¯å¾„
2. åŒ¹é…é€‚ç”¨çš„è§„åˆ™
3. æŒ‰ä¼˜å…ˆçº§æ’åº
4. æ‰§è¡Œè§„åˆ™åŠ¨ä½œ
5. è¿”å›æ‰§è¡Œç»“æœ

---

## ğŸ“ è§„åˆ™å®šä¹‰æ ¼å¼

### è§„åˆ™æ–‡ä»¶ç»“æ„

è§„åˆ™æ–‡ä»¶å­˜å‚¨åœ¨ `config/rules/` ç›®å½•ï¼Œä½¿ç”¨ JSON æ ¼å¼ï¼š

```json
{
  "id": "unique-rule-id",
  "name": "è§„åˆ™åç§°",
  "description": "è§„åˆ™æè¿°",
  "priority": 5,
  "enabled": true,
  "conditions": {
    "fileType": "javascript",
    "pathPattern": "src/**/*.js",
    "exclude": ["node_modules/**", "dist/**"]
  },
  "actions": {
    "format": true,
    "validate": true,
    "autofix": true,
    "linter": "eslint"
  },
  "config": {
    "maxLineLength": 100,
    "indentSize": 2,
    "semicolons": true
  }
}
```

### å­—æ®µè¯´æ˜

#### å…ƒæ•°æ®å­—æ®µ
- **id** (å¿…å¡«): è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦
- **name** (å¿…å¡«): äººç±»å¯è¯»çš„è§„åˆ™åç§°
- **description**: è§„åˆ™æè¿°
- **priority** (1-10): ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
- **enabled**: æ˜¯å¦å¯ç”¨è¯¥è§„åˆ™

#### conditions (æ¡ä»¶å¯¹è±¡)
å®šä¹‰è§„åˆ™ä½•æ—¶è§¦å‘ï¼š
- **fileType**: æ–‡ä»¶ç±»å‹ï¼ˆå¦‚ "javascript", "python", "markdown"ï¼‰
- **pathPattern**: æ–‡ä»¶è·¯å¾„æ¨¡å¼ï¼ˆæ”¯æŒ glob è¯­æ³•ï¼‰
- **exclude**: æ’é™¤çš„è·¯å¾„æ¨¡å¼

#### actions (åŠ¨ä½œå¯¹è±¡)
å®šä¹‰è§„åˆ™è§¦å‘åçš„è¡Œä¸ºï¼š
- **format**: æ˜¯å¦æ ¼å¼åŒ–ä»£ç 
- **validate**: æ˜¯å¦éªŒè¯ä»£ç 
- **autofix**: æ˜¯å¦è‡ªåŠ¨ä¿®å¤é—®é¢˜
- **linter**: ä½¿ç”¨çš„linterå·¥å…·

#### config (é…ç½®å¯¹è±¡)
è§„åˆ™çš„å…·ä½“é…ç½®å‚æ•°ï¼Œæ ¹æ®ä¸åŒè§„åˆ™ç±»å‹è€Œå¼‚ã€‚

---

## ğŸ”§ API å‚è€ƒ

### åˆ›å»º RuleManager å®ä¾‹

```javascript
const { createRuleManager } = require('./src/index.js');

const ruleManager = createRuleManager({
  rulesDirectory: './config/rules',  // è§„åˆ™ç›®å½•
  autoLoad: true,                    // è‡ªåŠ¨åŠ è½½è§„åˆ™
  logger: console                    // æ—¥å¿—å¯¹è±¡
});
```

### ç›‘å¬äº‹ä»¶

```javascript
// è§„åˆ™åŠ è½½å®Œæˆ
ruleManager.on('rulesLoaded', (count) => {
  console.log(`å·²åŠ è½½ ${count} æ¡è§„åˆ™`);
});

// è§„åˆ™æ·»åŠ 
ruleManager.on('ruleAdded', (rule) => {
  console.log(`æ·»åŠ è§„åˆ™: ${rule.name}`);
});

// è§„åˆ™åˆ é™¤
ruleManager.on('ruleRemoved', (ruleId) => {
  console.log(`åˆ é™¤è§„åˆ™: ${ruleId}`);
});

// é”™è¯¯å¤„ç†
ruleManager.on('error', (error) => {
  console.error('è§„åˆ™ç®¡ç†å™¨é”™è¯¯:', error);
});
```

### è§„åˆ™æ“ä½œç¤ºä¾‹

```javascript
// æ·»åŠ è§„åˆ™
const newRule = {
  id: 'my-rule',
  name: 'æˆ‘çš„è§„åˆ™',
  priority: 5,
  enabled: true,
  conditions: { fileType: 'javascript' },
  actions: { format: true }
};
ruleManager.addRule(newRule);

// è·å–è§„åˆ™
const rule = ruleManager.getRule('my-rule');

// åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„è§„åˆ™
const enabledRules = ruleManager.listRules({ enabled: true });

// ç¦ç”¨è§„åˆ™
ruleManager.disableRule('my-rule');

// åˆ é™¤è§„åˆ™
ruleManager.removeRule('my-rule');
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ä»£ç æäº¤å‰éªŒè¯

```bash
#!/bin/bash
# pre-commit hook

cd /home/averyubuntu/projects/rules

# éªŒè¯æ‰€æœ‰è§„åˆ™é…ç½®
node src/index.js validate

# åº”ç”¨è§„åˆ™åˆ°æš‚å­˜æ–‡ä»¶
git diff --cached --name-only | while read file; do
  node src/index.js apply --path "$file"
done
```

### ç¤ºä¾‹2: æ‰¹é‡æ ¼å¼åŒ–é¡¹ç›®

```bash
# æ ¼å¼åŒ–æ‰€æœ‰ JavaScript æ–‡ä»¶
cd /home/averyubuntu/projects/rules
node src/index.js apply --path "src/**/*.js" --format

# æ ¼å¼åŒ–ç‰¹å®šç›®å½•
node src/index.js apply --path "src/components/" --format --autofix
```

### ç¤ºä¾‹3: åœ¨ä»£ç ä¸­ä½¿ç”¨

```javascript
const RuleEngine = require('./src/rule-engine.js');
const RuleManager = require('./src/rule-manager.js');

// åˆ›å»ºç®¡ç†å™¨å’Œå¼•æ“
const manager = new RuleManager({
  rulesDirectory: './config/rules'
});

const engine = new RuleEngine(manager);

// åº”ç”¨è§„åˆ™åˆ°æ–‡ä»¶
async function checkFile(filePath) {
  const result = await engine.applyToFile(filePath, {
    format: true,
    validate: true
  });
  
  console.log(`æ–‡ä»¶ ${filePath}:`);
  console.log(`- åº”ç”¨è§„åˆ™æ•°: ${result.appliedRules}`);
  console.log(`- å‘ç°é—®é¢˜: ${result.issues}`);
  console.log(`- è‡ªåŠ¨ä¿®å¤: ${result.fixed}`);
}

// æ‰¹é‡å¤„ç†
const files = ['src/index.js', 'src/app.js'];
engine.applyToFiles(files).then(results => {
  console.log('æ‰¹é‡å¤„ç†å®Œæˆ:', results);
});
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. è§„åˆ™ä¼˜å…ˆçº§è®¾è®¡
- **1-3**: å»ºè®®æ€§è§„åˆ™ï¼ˆä¸é˜»å¡æäº¤ï¼‰
- **4-6**: è­¦å‘Šçº§è§„åˆ™ï¼ˆæç¤ºä½†å…è®¸ï¼‰
- **7-10**: é”™è¯¯çº§è§„åˆ™ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 2. è§„åˆ™æ–‡ä»¶ç»„ç»‡
```
config/rules/
â”œâ”€â”€ javascript/
â”‚   â”œâ”€â”€ format.json
â”‚   â”œâ”€â”€ lint.json
â”‚   â””â”€â”€ security.json
â”œâ”€â”€ python/
â”‚   â”œâ”€â”€ pep8.json
â”‚   â””â”€â”€ type-check.json
â””â”€â”€ general/
    â””â”€â”€ file-naming.json
```

### 3. è§„åˆ™ç»§æ‰¿ä¸è¦†ç›–
åŸºç¡€è§„åˆ™ â†’ é¡¹ç›®è§„åˆ™ â†’ æœ¬åœ°è§„åˆ™

### 4. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨è·¯å¾„æ’é™¤å‡å°‘ä¸å¿…è¦çš„æ£€æŸ¥
- åˆç†è®¾ç½®è§„åˆ™ä¼˜å…ˆçº§
- å¯ç”¨ç¼“å­˜ï¼ˆå¦‚æœæ”¯æŒï¼‰

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: è§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ**
```bash
# 1. æ£€æŸ¥è§„åˆ™æ˜¯å¦å¯ç”¨
node src/index.js list --enabled

# 2. éªŒè¯è§„åˆ™é…ç½®
node src/index.js validate

# 3. æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦åŒ¹é…
# ç¡®è®¤ pathPattern å’Œ exclude é…ç½®
```

**Q: è§„åˆ™åŠ è½½å¤±è´¥ï¼Ÿ**
```bash
# æ£€æŸ¥è§„åˆ™ç›®å½•
ls -la config/rules/

# éªŒè¯ JSON æ ¼å¼
cat config/rules/my-rule.json | jq .
```

**Q: æ€§èƒ½é—®é¢˜ï¼Ÿ**
- å‡å°‘è§„åˆ™æ•°é‡
- ä¼˜åŒ–è·¯å¾„åŒ¹é…æ¨¡å¼
- å¢åŠ æ’é™¤ç›®å½•

---

## ğŸ”„ é›†æˆåˆ°å·¥ä½œæµ

### Git Hooks é›†æˆ

åˆ›å»º `.git/hooks/pre-commit`:
```bash
#!/bin/bash
cd /home/averyubuntu/projects/rules
node src/index.js validate --staged
exit $?
```

### CI/CD é›†æˆ

```yaml
# .github/workflows/rules-check.yml
name: Rules Check
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run rules validation
        run: |
          cd /home/averyubuntu/projects/rules
          node src/index.js validate --all
```

### IDE é›†æˆ

VS Code settings.json:
```json
{
  "emeraldwalk.runonsave": {
    "commands": [
      {
        "match": ".*\\.(js|ts)$",
        "cmd": "cd /home/averyubuntu/projects/rules && node src/index.js apply --path ${file}"
      }
    ]
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å¿«é€Ÿå‚è€ƒ**: @tools/_registry.mdc
- **é¡¹ç›®README**: /home/averyubuntu/projects/rules/README.md
- **ä½¿ç”¨æŒ‡å—**: /home/averyubuntu/projects/rules/docs/usage-guide.md
- **APIæ–‡æ¡£**: /home/averyubuntu/projects/rules/docs/api-reference.md
- **è§„åˆ™å®šä¹‰**: /home/averyubuntu/projects/rules/docs/rules-definition.md

---

## ğŸš€ æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ç±»å‹

```javascript
// åœ¨ rule-engine.js ä¸­æ‰©å±•
class CustomRuleEngine extends RuleEngine {
  async executeCustomRule(rule, filePath, options) {
    // è‡ªå®šä¹‰è§„åˆ™é€»è¾‘
  }
}
```

### æ·»åŠ æ–°çš„æ–‡ä»¶ç±»å‹æ”¯æŒ

```javascript
// åœ¨ rule-engine.js çš„ getFileType æ–¹æ³•ä¸­æ·»åŠ 
getFileType(ext) {
  const types = {
    '.js': 'javascript',
    '.py': 'python',
    '.go': 'golang',  // æ–°å¢
    // ...
  };
  return types[ext] || 'unknown';
}
```

---

**æœ€åæ›´æ–°**: 2025-01-07
